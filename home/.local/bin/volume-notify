#!/bin/sh
#
# Displays a notification with volume changes. Eventually, this should be
# rewritten as a deamon that connects to PA and receives volume notification
# events.
#
# Possible libs for that:
# https://github.com/jnqnfe/pulse-binding-rust
# https://pypi.org/project/pulsectl/
#
# Waybar also has a module that updates on changes, many the code from there
# can be reuse for this?

set -ex

show() {
  if ponymix --sink is-muted; then
    VOL_ICON=""
    VOLUME="$(ponymix get-volume)"
  else
    VOL_ICON=""
    VOLUME="$(ponymix get-volume)"
  fi
  OUTPUT_DEVICE=$(ponymix --short --sink | grep sink | cut -f 4)

  if ponymix --source is-muted; then
    MIC_ICON=""
  else
    MIC_ICON=""
  fi
  MIC="$MIC_ICON $(ponymix --source get-volume)"

  notify-send \
    --urgency=low \
    --expire-time=1800 \
    --hint=int:transient:1 \
    --hint=int:value:"$VOLUME" \
    --hint=string:x-dunst-stack-tag:volctl \
    --hint=string:x-canonical-private-synchronous:volctl \
    "Volume changed" \
    "Using $OUTPUT_DEVICE \n$VOL_ICON  $VOLUME% $MIC%"
}

monitor() {
  # Monitors for changes in sink states.

  pactl subscribe | /usr/bin/grep --line-buffered "'change' on s" |
    while read -r _; do
      show
    done
  exit
}

monitor
