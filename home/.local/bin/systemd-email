#!/bin/sh
#
# Emails the results of the last run of a given script.
# See https://serverfault.com/a/814467/32648
#
# Usage: systemd-email SERVICE-NAME

if [ -z $1 ]; then
  echo No unit provided
  exit 1
fi

ts=$(systemctl --user show -p ExecMainStartTimestamp $1 | awk '{print $2 $3}')
logs=$(journalctl --user -u $1 --since "$(echo $ts)" --output cat)
exit_status=$(systemctl --user show -p ExecMainStatus $1)
exit_code=$(echo $exit_status | tr '=' ' ' | awk '{print $2}')

if [ $exit_code = 0 ]; then
  result="success"
else
  result="failure"
fi

/usr/bin/sendmail -t <<EOF
To: $EMAIL
From: systemd <$USER@$HOSTNAME>
Subject: $1: $result
Content-Transfer-Encoding: 8bit
Content-Type: text/plain; charset=UTF-8

$logs
EOF
