#!/usr/bin/env zsh

if [ -z $1 ]; then
  echo No host specified
  exit 1
fi

if [ -z $2 ]; then
  echo No port specified
  exit 2
fi

if [ -z $1 ]; then
  MONITOR="0"
fi

HOST=$1
PORT=$2
MONITOR=$3

# Kill current proxy
pgrep -f "autossh.*$PORT" > /dev/null
if [ $? == 0 ]; then
  for p in $(pstree -p $(pgrep -f "autossh.*$PORT") | grep -oE '[0-9]+'); do
    kill -KILL $p
  done;
fi;

# Set up the new proxy
if [ -z "`lsof -i :$PORT | grep LISTEN`" ]; then
  autossh -M $MONITOR -fND $PORT $HOST
else
  echo "Error: Port $PORT in use (and not by autossh)."
fi
